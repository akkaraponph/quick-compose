server {
    listen 80;
    server_name loki.localhost;

    client_max_body_size 100M;

    location / {
        proxy_pass http://loki:3100;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts for log ingestion
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # Loki push API endpoint (for Promtail)
    location /loki/api/v1/push {
        proxy_pass http://loki:3100/loki/api/v1/push;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Special handling for log ingestion
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_http_version 1.1;
    }

    # Loki query API endpoint
    location /loki/api/v1/query {
        proxy_pass http://loki:3100/loki/api/v1/query;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Health check endpoint
    location /ready {
        proxy_pass http://loki:3100/ready;
        proxy_set_header Host $host;
    }

    # Metrics endpoint
    location /metrics {
        proxy_pass http://loki:3100/metrics;
        proxy_set_header Host $host;
    }

    # Logging
    access_log /var/log/nginx/loki_access.log;
    error_log /var/log/nginx/loki_error.log;
}
